import{r as n,j as e}from"./iframe-CbZ9RuD1.js";import{D as te,R as se,A as ae}from"./auth-models-DGfjT_QB.js";import{B as x}from"./button-CTUPBRYB.js";import{A as re,M as ne,a as oe,b as ie}from"./index-3wkwrokg.js";import{A as ce}from"./Alert-BOIqNkOl.js";import{D as le}from"./Dropdown-DtyJtPES.js";import{H as ue}from"./H2-DJkyENuB.js";import{P as de}from"./P-D7nAdz6Q.js";import{m as me,n as pe}from"./index.esm-Bh9o6rCW.js";import{L as he}from"./link-CLCsOSg8.js";import{R as xe}from"./RucioLogo-je1npqWy.js";import{I as w}from"./input-DudEH1ht.js";import{c as fe}from"./utils-DsKtx5Xo.js";import{m as h}from"./proxy-vEXAzVUV.js";import{t as L}from"./tw-merge-Ds6tgvmq.js";import"./preload-helper-Dp1pzeXC.js";import"./index-DSpI4bVK.js";import"./use-reduced-motion-CgJySeb8.js";import"./iconBase-BDSQWw1B.js";import"./warning-C20GYw-A.js";import"./index.esm-CDVKQKGR.js";const ve=s=>e.jsx(he,{href:"/dashboard",children:e.jsxs(x,{variant:"success",className:"mb-1 w-full",children:[e.jsx(me,{className:"mr-2 h-4 w-4"}),"Back to dashboard as ",s.account]})}),ge=({submit:s,availableAccounts:u,onClose:A})=>{const[b,y]=n.useState(void 0);return e.jsxs(ne,{isOpen:u.length!==0,onRequestClose:()=>{y(void 0),A()},ariaHideApp:!1,overlayClassName:"fixed inset-0 z-40 flex items-center justify-center bg-black bg-opacity-50",className:L("mx-2 max-w-3xl rounded shadow-lg z-50","border-2","bg-neutral-0 dark:bg-neutral-800","flex flex-col space-y-2 p-6","justify-center items-center overflow-y-visible outline-none focus:outline-none"),contentLabel:"Multiaccount Modal",children:[e.jsx(ue,{children:"Select Account"}),e.jsx(de,{className:"text-center py-2",children:"Multiple accounts are mapped to the passed credentials. Choose one to continue."}),e.jsx(le,{keys:u,renderFunc:f=>e.jsx("p",{children:f??"Select an account"}),handleChange:f=>{y(f)},disableUndefined:!0}),e.jsx(x,{type:"submit",variant:"success",className:"w-full",disabled:b===void 0,onClick:async()=>{await s(b)},children:"Select"})]})},C=({loginViewModel:s,authViewModel:u,userPassSubmitHandler:A,x509SubmitHandler:b,x509SessionHandler:y,oidcSubmitHandler:f})=>{const z=s.isLoggedIn&&s.accountActive!==void 0,[P,O]=n.useState("method-selection"),[d,_]=n.useState(0),[N,K]=n.useState(""),[S,$]=n.useState(""),[i,I]=n.useState(void 0),[k,c]=n.useState(void 0),[r,j]=n.useState({}),[v,T]=n.useState(!1),[G,U]=n.useState([]),[X,M]=n.useState(void 0),V=t=>{var o;if(t.status==="error")c(t.message);else if(t.status==="multiple_accounts"){const l=(o=t.message)==null?void 0:o.split(","),p=l==null?void 0:l.filter(ee=>{var B;return!((B=s.accountsAvailable)!=null&&B.includes(ee))});!p||p.length===0?c("All accounts associated with this identity are signed in to"):U(p)}},H=async t=>{var p;if(t&&((p=s.accountsAvailable)!=null&&p.includes(t))){c(`Already authenticated as ${t}`);return}const o=s.voList[d]||te,l=await b(o,s,t);l&&(M("x509"),V(l),y(l,l.rucioAccount,o.shortName))},J=()=>{const t={};return N.trim()||(t.username="Username is required"),S.trim()||(t.password="Password is required"),j(t),Object.keys(t).length===0},m=async t=>{var o;if(c(void 0),j({}),!!J()){if(t&&((o=s.accountsAvailable)!=null&&o.includes(t))){c(`Already authenticated as ${t}`);return}T(!0);try{A(N,S,s.voList[d],t),M("userpass")}finally{T(!1)}return Promise.resolve()}};n.useEffect(()=>{u?V(u):s&&s.status==="error"&&c(s.message)},[s,u]);const a=window.matchMedia("(prefers-reduced-motion: reduce)").matches,Q={hidden:a?{opacity:1}:{opacity:0,scale:.8},visible:{opacity:1,scale:1,transition:a?{duration:0}:{duration:.5,ease:"easeInOut"}}},W={hidden:a?{opacity:1}:{opacity:0,scale:1.5},visible:{opacity:1,scale:1,transition:a?{duration:0}:{duration:.5,ease:"easeInOut"}}},F={enter:t=>({x:a?0:t>0?300:-300,opacity:a?1:0}),center:{x:0,opacity:1,transition:a?{duration:0}:{duration:.3,ease:"easeInOut"}},exit:t=>({x:a?0:t<0?300:-300,opacity:a?1:0,transition:a?{duration:0}:{duration:.3,ease:"easeInOut"}})},Y=()=>e.jsxs(h.div,{custom:-1,variants:F,initial:"enter",animate:"center",exit:"exit",className:"w-full",children:[s.multiVOEnabled&&e.jsx("div",{className:"mb-4",children:e.jsx(oe,{tabs:s.voList.map(t=>t.name),activeIndex:d,onTabChange:t=>_(t),ariaLabel:"Select Virtual Organisation"})}),e.jsxs("div",{className:"flex justify-center flex-col space-y-4 mt-4","aria-label":"Choose Login Method",children:[s.oidcEnabled==!0?e.jsx("div",{className:L("flex flex-row justify-center space-x-2",s.voList[d].oidcEnabled?"":"hidden"),"aria-label":"OIDC Login Buttons",children:s.voList[d].oidcProviders.map((t,o)=>e.jsxs(x,{variant:"neutral",onClick:()=>f(t,s.voList[d],i),className:"w-full",children:[e.jsx(ie,{className:"mr-2 h-4 w-4"}),t.name]},o.toString()))}):e.jsx(e.Fragment,{}),e.jsx(x,{onClick:()=>H(i),className:"w-full",children:"x509"}),s.userpassEnabled&&e.jsx(x,{onClick:()=>{c(void 0),j({}),O("userpass-form")},className:"w-full",children:"Userpass"}),!s.userpassEnabled&&e.jsxs("div",{className:"space-y-2 px-2",children:[e.jsxs("label",{htmlFor:"account-input-nouserpass",className:"block text-sm font-medium text-neutral-900 dark:text-neutral-100",children:["Account ",e.jsx("span",{className:"text-neutral-500",children:"(optional)"})]}),e.jsx(w,{id:"account-input-nouserpass",type:"text",value:i||"",onChange:t=>I(t.target.value||void 0),placeholder:"Enter account name",className:"w-full"})]})]})]},"method-selection"),Z=()=>e.jsxs(h.div,{custom:1,variants:F,initial:"enter",animate:"center",exit:"exit",className:"w-full",children:[e.jsx("div",{className:"mb-4",children:e.jsxs("button",{onClick:()=>{c(void 0),j({}),O("method-selection")},className:fe("flex items-center gap-2","text-sm text-neutral-700 dark:text-neutral-300","hover:text-neutral-900 dark:hover:text-neutral-100","transition-colors","focus:outline-none focus:ring-2 focus:ring-brand-500 focus:ring-offset-2","rounded px-2 py-1"),"aria-label":"Back to login methods",children:[e.jsx(pe,{className:"w-4 h-4"}),e.jsx("span",{children:"Back"})]})}),e.jsx(h.form,{onSubmit:t=>{t.preventDefault(),m(i)},animate:r.username||r.password?a?{}:{x:[0,-10,10,-10,10,0]}:{},transition:{duration:.4},children:e.jsxs("fieldset",{className:"flex flex-col space-y-4","aria-label":"Userpass Login Fields",id:"userpass-form",children:[e.jsxs("div",{className:"flex flex-col space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{htmlFor:"username-input",className:"block text-sm font-medium text-neutral-900 dark:text-neutral-100",children:"Username"}),e.jsx(w,{id:"username-input",type:"text",value:N,onChange:t=>K(t.target.value),error:!!r.username,"aria-describedby":r.username?"username-error":void 0,"aria-invalid":!!r.username,disabled:v,placeholder:"Enter your username",onEnterKey:()=>m(i),className:"w-full"}),e.jsx("div",{className:"min-h-[20px]",children:r.username&&e.jsx("p",{id:"username-error",className:"text-sm text-base-error-600 dark:text-base-error-500",children:r.username})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{htmlFor:"password-input",className:"block text-sm font-medium text-neutral-900 dark:text-neutral-100",children:"Password"}),e.jsx(w,{id:"password-input",type:"password",value:S,onChange:t=>$(t.target.value),error:!!r.password,"aria-describedby":r.password?"password-error":void 0,"aria-invalid":!!r.password,disabled:v,placeholder:"Enter your password",onEnterKey:()=>m(i),className:"w-full"}),e.jsx("div",{className:"min-h-[20px]",children:r.password&&e.jsx("p",{id:"password-error",className:"text-sm text-base-error-600 dark:text-base-error-500",children:r.password})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{htmlFor:"account-input",className:"block text-sm font-medium text-neutral-900 dark:text-neutral-100",children:["Account ",e.jsx("span",{className:"text-neutral-500",children:"(optional)"})]}),e.jsx(w,{id:"account-input",type:"text",value:i||"",onChange:t=>I(t.target.value||void 0),disabled:v,placeholder:"Enter account name",onEnterKey:()=>m(i),className:"w-full"})]})]}),e.jsx(x,{type:"submit",variant:"success",role:"button",onClick:()=>m(i),disabled:v,className:"w-full",children:v?"Signing in...":"Login"})]})})]},"userpass-form");return e.jsx(h.div,{initial:"hidden",animate:"visible",variants:W,className:"flex items-center justify-center min-h-screen py-8",children:e.jsxs("div",{children:[z&&e.jsx("div",{className:"mb-4",children:e.jsx(ve,{account:s.accountActive})}),e.jsxs("div",{className:L("flex flex-col items-center justify-between","border dark:border-2 rounded-xl p-4 md:p-6 flex flex-col justify-center space-y-4","border-neutral-300 dark:border-neutral-700","bg-neutral-50/90 dark:bg-neutral-900/90","backdrop-blur-xl","w-[90vw] md:w-[480px] mx-auto","shadow-xl"),id:"root",children:[e.jsx(ge,{submit:X==="x509"?H:m,availableAccounts:G,onClose:()=>U([])}),e.jsx("div",{className:`min-h-[52px] w-full ${k?"":"hidden"}`,role:"alert","aria-live":"polite","aria-atomic":"true","data-testid":"login-page-error",children:k&&e.jsx(h.div,{initial:a?{opacity:1}:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:a?{opacity:1}:{opacity:0,y:-10},transition:a?{duration:0}:{duration:.2,ease:"easeInOut"},children:e.jsx(ce,{variant:"error",message:k,onClose:()=>{c(void 0)}})})}),e.jsx("div",{className:"flex flex-col items-center justify-between w-full text-center",children:e.jsx(h.div,{initial:"hidden",animate:"visible",variants:Q,children:e.jsx(xe,{className:"text-neutral-900 dark:text-neutral-100",width:120,height:120,"aria-label":"Rucio Logo"})})}),e.jsx("div",{className:"w-full overflow-hidden",children:e.jsx(re,{mode:"wait",custom:P==="userpass-form"?1:-1,children:P==="method-selection"?Y():Z()})})]})]})})};C.__docgenInfo={description:"",methods:[],displayName:"Login",props:{loginViewModel:{required:!0,tsType:{name:"LoginViewModel"},description:""},authViewModel:{required:!0,tsType:{name:"union",raw:"AuthViewModel | undefined",elements:[{name:"AuthViewModel"},{name:"undefined"}]},description:""},userPassSubmitHandler:{required:!0,tsType:{name:"signature",type:"function",raw:"(username: string, password: string, vo: VO, account?: string) => void",signature:{arguments:[{type:{name:"string"},name:"username"},{type:{name:"string"},name:"password"},{type:{name:"VO"},name:"vo"},{type:{name:"string"},name:"account"}],return:{name:"void"}}},description:""},x509SubmitHandler:{required:!0,tsType:{name:"signature",type:"function",raw:"(vo: VO, loginViewModel: LoginViewModel, account?: string) => Promise<AuthViewModel | undefined>",signature:{arguments:[{type:{name:"VO"},name:"vo"},{type:{name:"LoginViewModel"},name:"loginViewModel"},{type:{name:"string"},name:"account"}],return:{name:"Promise",elements:[{name:"union",raw:"AuthViewModel | undefined",elements:[{name:"AuthViewModel"},{name:"undefined"}]}],raw:"Promise<AuthViewModel | undefined>"}}},description:""},x509SessionHandler:{required:!0,tsType:{name:"signature",type:"function",raw:"(authViewModel: AuthViewModel, rucioAccount: string, shortVoName: string) => void",signature:{arguments:[{type:{name:"AuthViewModel"},name:"authViewModel"},{type:{name:"string"},name:"rucioAccount"},{type:{name:"string"},name:"shortVoName"}],return:{name:"void"}}},description:""},oidcSubmitHandler:{required:!0,tsType:{name:"signature",type:"function",raw:"(oidcProvider: OIDCProvider, vo: VO, account?: string) => void",signature:{arguments:[{type:{name:"OIDCProvider"},name:"oidcProvider"},{type:{name:"VO"},name:"vo"},{type:{name:"string"},name:"account"}],return:{name:"void"}}},description:""}}};const Ke={title:"Components/Pages/Login",component:C},be=s=>e.jsx(C,{...s}),E={name:"CERN",url:"https://login.cern.ch/adfs/oauth2/authorize",clientId:"1234567890",clientSecret:"1234567890",authorizationUrl:"https://login.cern.ch/adfs/oauth2/authorize",tokenUrl:"https://login.cern.ch/adfs/oauth2/token",refreshTokenUrl:"https://login.cern.ch/adfs/oauth2/token",redirectUrl:"https://login.cern.ch/adfs/oauth2/authorize"},ye={name:"Google",url:"https://accounts.google.com/o/oauth2/v2/auth",clientId:"1234567890",clientSecret:"1234567890",authorizationUrl:"https://accounts.google.com/o/oauth2/v2/auth",tokenUrl:"https://oauth2.googleapis.com/token",redirectUrl:"https://accounts.google.com/o/oauth2/v2/auth"},je={name:"ATLAS",shortName:"atl",logoUrl:"https://atlas.cern/wp-content/uploads/2019/07/ATLAS-Logo-1.png",oidcEnabled:!0,oidcProviders:[E]},we={name:"CMS",shortName:"cms",logoUrl:"https://cms.cern/wp-content/uploads/2019/07/CMS-Logo-1.png",oidcEnabled:!0,oidcProviders:[E,ye]},g=be.bind({});g.args={loginViewModel:{status:"success",userpassEnabled:!0,x509Enabled:!0,oidcEnabled:!0,oidcProviders:[E],multiVOEnabled:!0,voList:[je,we],isLoggedIn:!1,accountsAvailable:void 0,accountActive:void 0,rucioAuthHost:"https://rucio.cern.ch"},authViewModel:{status:"error",message:"Invalid Login Credentials",rucioIdentity:"",rucioAccount:"",rucioMultiAccount:"",rucioAuthToken:"",rucioAuthType:ae.USERPASS,rucioAuthTokenExpires:"",role:se.USER}};var R,D,q;g.parameters={...g.parameters,docs:{...(R=g.parameters)==null?void 0:R.docs,source:{originalSource:"args => <Login {...args} />",...(q=(D=g.parameters)==null?void 0:D.docs)==null?void 0:q.source}}};const $e=["LoginPage"];export{g as LoginPage,$e as __namedExportsOrder,Ke as default};
